---
title: "Osteoporosis Dashboard"
author: "Ramya Thiyagarajan"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include= FALSE}
# Load required libraries
library(ggplot2)
library(dplyr)
library(plotly)
library(naniar)
library(shiny)
library(flexdashboard)
library(DT)

# Load data
clean_data <- read.csv("cleaned_data_with_missing.csv")

# Handle missing data for analysis (filter out rows with missing BMD/BMC)
clean_data_filtered <- clean_data %>% 
  filter(!is.na(Spine_BMD), !is.na(Spine_BMC))
# Summary of missing data
missing_summary <- colSums(is.na(clean_data))
missing_summary_df <- data.frame(
  Variable = names(missing_summary),
  MissingCount = missing_summary
)

# Plot missing data
library(naniar)
#missing_plot <- vis_miss(clean_data)

# Display missing data summary
#missing_summary_df
#missing_plot
```
```{r}
# Calculate the total number of osteoporosis cases
#clean_data$Hist_Osteoporosis <- as.numeric(as.character(clean_data$Hist_Osteoporosis))
total_osteoporosis <- sum(clean_data$Hist_Osteoporosis == 'Yes', na.rm = TRUE)

# Display the total number of osteoporosis cases
#total_osteoporosis
patient_fam_hist <- sum(clean_data$Parent_Osteo == 'Yes', na.rm = TRUE)

```
# {.sidebar}

![](ortho.jpg){width="20%"}

### Summary of Osteoporosis Cases
- **Total Osteoporosis Cases**: `r total_osteoporosis`

### Family history of Osteoporosis Cases
- **Patients with family history of Osteoporosis**: `r patient_fam_hist`

Filters
```{r}
selectInput("gender_filter", "Select Gender:", 
            choices = c("All", unique(clean_data$RIAGENDR)), 
            selected = "All")

selectInput("osteoporosis_filter", "Select Osteoporosis History:", 
            choices = c("All", "Yes", "No"), 
            selected = "All")

sliderInput("bmd_filter", "Filter by Spine BMD:", 
            min = min(clean_data$Spine_BMD, na.rm = TRUE), 
            max = max(clean_data$Spine_BMD, na.rm = TRUE), 
            value = c(min(clean_data$Spine_BMD, na.rm = TRUE), 
                      max(clean_data$Spine_BMD, na.rm = TRUE)))
```

# Main
Column {data-width=600}
-------------------------------------
### Distribution of Spine BMD by Osteoporosis History

```{r}
renderPlotly({
  filtered_data <- clean_data
  if (input$gender_filter != "All") {
    filtered_data <- filtered_data %>% filter(RIAGENDR == input$gender_filter)
  }
  if (input$osteoporosis_filter != "All") {
    filtered_data <- filtered_data %>% filter(Hist_Osteoporosis == input$osteoporosis_filter)
  }
  filtered_data <- filtered_data %>% 
    filter(Spine_BMD >= input$bmd_filter[1], Spine_BMD <= input$bmd_filter[2])
  
  p <- ggplot(filtered_data, aes(x = factor(Hist_Osteoporosis), y = Spine_BMD, fill = factor(Hist_Osteoporosis))) +
    geom_boxplot() +
    labs(
      title = "Distribution of Spine BMD by Osteoporosis History",
      x = "Osteoporosis History",
      y = "Spine BMD (Bone Mineral Density)",
      fill = "Osteoporosis History"
    ) +
    scale_x_discrete(labels = c("No", "Yes")) +
    theme_minimal()
  
  ggplotly(p)
})
```
Column {data-width=600}
-------------------------------------
### Osteoporosis by Gender

```{r}
renderPlotly({
  filtered_data <- clean_data
  if (input$gender_filter != "All") {
    filtered_data <- filtered_data %>% filter(RIAGENDR == input$gender_filter)
  }
  if (input$osteoporosis_filter != "All") {
    filtered_data <- filtered_data %>% filter(Hist_Osteoporosis == input$osteoporosis_filter)
  }
  filtered_data <- filtered_data %>% 
    filter(Spine_BMD >= input$bmd_filter[1], Spine_BMD <= input$bmd_filter[2])
  
  p <- filtered_data %>%
    group_by(RIAGENDR, Hist_Osteoporosis) %>%
    summarize(Count = n(), .groups = "drop") %>%
    ggplot(aes(x = RIAGENDR, y = Count, fill = factor(Hist_Osteoporosis))) +
    geom_bar(stat = "identity", position = "dodge") +
    labs(title = "Osteoporosis by Gender", x = "Gender", y = "Count", fill = "Osteoporosis History") +
    theme_minimal()
  
  ggplotly(p)
})
```


### Distribution of Spine BMC by Osteoporosis History

```{r}
renderPlotly({
  filtered_data <- clean_data
  if (input$gender_filter != "All") {
    filtered_data <- filtered_data %>% filter(RIAGENDR == input$gender_filter)
  }
  if (input$osteoporosis_filter != "All") {
    filtered_data <- filtered_data %>% filter(Hist_Osteoporosis == input$osteoporosis_filter)
  }
  filtered_data <- filtered_data %>% 
    filter(Spine_BMD >= input$bmd_filter[1], Spine_BMD <= input$bmd_filter[2])
  
  p <- ggplot(filtered_data, aes(x = factor(Hist_Osteoporosis), y = Spine_BMC, fill = factor(Hist_Osteoporosis))) +
    geom_boxplot() +
    labs(
      title = "Distribution of Spine BMC by Osteoporosis History",
      x = "Osteoporosis History",
      y = "Spine BMC (Bone Mineral Density)",
      fill = "Osteoporosis History"
    ) +
    scale_x_discrete(labels = c("No", "Yes")) +
    theme_minimal()
  
  ggplotly(p)
})
```


Column {data-width=600}
-------------------------------------
### Violin Plot for Spine BMD by Osteoporosis History

```{r}
renderPlotly({
  filtered_data <- clean_data
  if (input$gender_filter != "All") {
    filtered_data <- filtered_data %>% filter(RIAGENDR == input$gender_filter)
  }
  if (input$osteoporosis_filter != "All") {
    filtered_data <- filtered_data %>% filter(Hist_Osteoporosis == input$osteoporosis_filter)
  }
  filtered_data <- filtered_data %>% 
    filter(Spine_BMD >= input$bmd_filter[1], Spine_BMD <= input$bmd_filter[2])
  
  p <- ggplot(filtered_data, aes(x = factor(Hist_Osteoporosis), y = Spine_BMD, fill = factor(Hist_Osteoporosis))) +
    geom_violin(trim = FALSE) +  # Use trim = FALSE to show the full density
    labs(
      title = "Spine BMD Distribution by Osteoporosis History",
      x = "Osteoporosis History",
      y = "Spine BMD"
    ) +
    scale_x_discrete(labels = c("No", "Yes")) +
    theme_minimal()
  
  ggplotly(p)
})

```


# Data
column {data-width=1000}
-----------------------------
### Raw Data
```{r}
renderDT({
  clean_data %>%
    datatable(
      options = list(pageLength = 10, autoWidth = TRUE, scrollX = TRUE),
      rownames = FALSE
    )
})
```

